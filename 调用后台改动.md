# AI助手后台版改动说明

## 文件对比

| 文件 | 说明 |
|------|------|
| `ai助手最新样式隐藏json.html` | 前端直接调用 DeepSeek API，JSON 数据嵌入页面 |
| `ai助手最新样式后台.html` | 通过后台 API 代理调用，JSON 数据从后台获取 |

---

## 主要改动

### 1. 移除前端 API Key 输入

**原版：**
- 用户需要在前端输入 DeepSeek API Key
- API Key 存储在 localStorage
- 存在安全风险（Key 暴露在前端）

**后台版：**
- 移除了 API Key 输入区域
- 改为"连接状态"提示区域
- API Key 由后台管理，更安全

### 2. 移除嵌入的 JSON 数据

**原版：**
```html
<script id="hidden-json-data" type="application/json">
  <!-- Base64 编码的 JSON 数据 -->
</script>
```

**后台版：**
- 移除了嵌入的 JSON 数据
- 改为从后台接口动态获取

### 3. API 配置变更

**原版：**
```javascript
const API_CONFIG = {
  BASE_URL: 'https://api.deepseek.com/v1',
  MODEL: 'deepseek-chat',
  MAX_TOKENS: 2000,
  TEMPERATURE: 0.7
};
```

**后台版：**
```javascript
const API_CONFIG = {
  BACKEND_URL: '/api',           // 后台 API 地址
  CHAT_ENDPOINT: '/chat',        // 聊天接口
  CONTEXT_ENDPOINT: '/context',  // 获取上下文数据接口
  HEALTH_ENDPOINT: '/health'     // 健康检查接口
};
```

### 4. 新增后台连接逻辑

```javascript
// 页面加载时的初始化流程
window.addEventListener('load', async function () {
  // 1. 检查后台健康状态
  const isHealthy = await checkBackendHealth();

  // 2. 获取上下文数据
  contextData = await fetchContextData();

  // 3. 初始化聊天
  await initializeChat();
});
```

### 5. 聊天请求改为调用后台

**原版：** 直接调用 DeepSeek API
```javascript
fetch('https://api.deepseek.com/v1/chat/completions', {
  headers: { 'Authorization': 'Bearer ' + aiApiKey },
  body: JSON.stringify({ model: 'deepseek-chat', messages, stream: true })
});
```

**后台版：** 调用后台代理接口
```javascript
fetch('/api/chat', {
  body: JSON.stringify({ messages, stream: true })
});
```

---

## 后台需要实现的接口

### 1. 健康检查接口

```
GET /api/health
```

**响应：**
- 成功：HTTP 200
- 失败：HTTP 5xx

### 2. 获取上下文数据接口

```
GET /api/context
```

**响应示例：**
```json
{
  "system": "你是一个专业的助手，下面是本次报告的内容，需要报告内容来回答问题。",
  "context": {
    "report_metadata": {
      "title": "空间转录组深度分析报告",
      "project_name": "report中增加ai助手测试项目",
      "sample_info": {
        "sample_id": "LUAD_S1, LUAD_S2",
        "slide_id": "LUAD_S1, LUAD_S2",
        "species": "hs",
        "tissue_type": "肺部"
      },
      "analysis_date": "2025-11-17",
      "pipeline_version": "深度分析"
    },
    "analysis_modules": {
      "1_0_loadData": {
        "module_name": "数据加载",
        "description": "原始数据加载和格式转换",
        "output_summary": "加载了278328个细胞，6738个基因",
        "key_metrics": {
          "total_cells": 278328,
          "total_genes": 6738
        }
      }
      // ... 更多模块
    }
  },
  "instructions": "回答问题时要考虑报告内容，对于超出范围的问题要明确告知用户，回答问题不要使用Markdown格式。"
}
```

### 3. 聊天接口（流式响应）

```
POST /api/chat
Content-Type: application/json
```

**请求体：**
```json
{
  "messages": [
    { "role": "system", "content": "你是一个专业的助手..." },
    { "role": "user", "content": "这份报告分析了多少个细胞？" }
  ],
  "stream": true
}
```

**响应格式（SSE 流式）：**
```
data: {"choices":[{"delta":{"content":"这份"}}]}

data: {"choices":[{"delta":{"content":"报告"}}]}

data: {"choices":[{"delta":{"content":"分析了"}}]}

data: [DONE]
```

---

## 后台实现示例（Python Flask）

```python
from flask import Flask, request, Response, jsonify
import requests
import json
import os

app = Flask(__name__)

# DeepSeek API 配置
DEEPSEEK_API_KEY = os.environ.get('DEEPSEEK_API_KEY')
DEEPSEEK_API_URL = 'https://api.deepseek.com/v1/chat/completions'

# 上下文数据（可以从文件或数据库读取）
CONTEXT_DATA = {
    "system": "你是一个专业的助手...",
    "context": { ... },
    "instructions": "回答问题时要考虑报告内容..."
}

@app.route('/api/health', methods=['GET'])
def health():
    return jsonify({"status": "ok"}), 200

@app.route('/api/context', methods=['GET'])
def get_context():
    # 可以根据请求参数返回不同报告的上下文
    return jsonify(CONTEXT_DATA)

@app.route('/api/chat', methods=['POST'])
def chat():
    data = request.json
    messages = data.get('messages', [])
    stream = data.get('stream', True)

    def generate():
        response = requests.post(
            DEEPSEEK_API_URL,
            headers={
                'Authorization': f'Bearer {DEEPSEEK_API_KEY}',
                'Content-Type': 'application/json'
            },
            json={
                'model': 'deepseek-chat',
                'messages': messages,
                'stream': stream,
                'temperature': 0.7,
                'max_tokens': 2000
            },
            stream=True
        )

        for line in response.iter_lines():
            if line:
                yield line.decode('utf-8') + '\n'

    return Response(generate(), mimetype='text/event-stream')

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8100)
```

---

## 部署注意事项

1. **修改 API 地址**：根据实际部署情况修改 `API_CONFIG.BACKEND_URL`
   ```javascript
   BACKEND_URL: 'https://your-server.com/api'  // 或相对路径 '/api'
   ```

2. **跨域配置**：如果前端和后台不在同一域名，后台需要配置 CORS

3. **API Key 安全**：确保 API Key 只在后台环境变量中，不要硬编码

4. **JSON 数据管理**：可以为不同报告配置不同的 JSON 文件，通过参数区分
