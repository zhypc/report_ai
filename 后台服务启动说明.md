# AI助手后台服务启动说明

## 文件说明

```
backend_server.py    # 后台服务主程序
requirements.txt     # Python 依赖
context_data.json    # 上下文数据配置（文件模式）
tools_prompt.json    # 工具提示词配置（文件模式）
init_database.py     # 数据库初始化脚本
```

## 快速启动

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 配置环境变量

```bash
# 必须：DeepSeek API Key
export DEEPSEEK_API_KEY='sk-your-api-key-here'

# 必须：访问秘钥（多个秘钥用逗号分隔）
export VALID_ACCESS_KEYS='key1,key2,key3'

# 数据源类型：file（默认）, mysql, sqlite
export DB_TYPE='file'

# 可选：服务器配置
export SERVER_HOST='0.0.0.0'
export SERVER_PORT='8100'
export DEBUG_MODE='false'

# 文件模式：上下文数据文件路径
export CONTEXT_FILE_PATH='context_data.json'
export TOOLS_PROMPT_FILE_PATH='tools_prompt.json'
```

### 3. 数据库配置（可选）

#### MySQL 配置

```bash
export DB_TYPE='mysql'
export MYSQL_HOST='localhost'
export MYSQL_PORT='3306'
export MYSQL_USER='root'
export MYSQL_PASSWORD='your_password'
export MYSQL_DATABASE='ai_assistant'

# 初始化数据库（创建表并插入示例数据）
python init_database.py
```

#### SQLite 配置

```bash
export DB_TYPE='sqlite'
export SQLITE_PATH='report_context.db'

# 初始化数据库（创建表并插入示例数据）
python init_database.py
```

### 4. 启动服务

**开发环境：**
```bash
python backend_server.py
```

**生产环境（使用 gunicorn）：**
```bash
gunicorn -w 4 -b 0.0.0.0:8100 backend_server:app
```

## 数据库表结构

### report_context 表（报告上下文）

```sql
CREATE TABLE report_context (
    id INT AUTO_INCREMENT PRIMARY KEY,
    report_id VARCHAR(100) UNIQUE NOT NULL,  -- 报告唯一标识
    project_name VARCHAR(255),                -- 项目名称
    system_prompt TEXT,                       -- 系统提示词
    context_data JSON,                        -- 上下文JSON数据
    instructions TEXT,                        -- 回答指令
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_active TINYINT(1) DEFAULT 1            -- 是否启用
);
```

### tools_prompt 表（工具提示词）

```sql
CREATE TABLE tools_prompt (
    id INT AUTO_INCREMENT PRIMARY KEY,
    prompt_id VARCHAR(100) UNIQUE NOT NULL,   -- 提示词唯一标识
    tools_system_prompt TEXT,                 -- 工具系统提示词
    recommendation_instructions TEXT,          -- 推荐指令
    tools_data JSON,                          -- 工具JSON数据
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_active TINYINT(1) DEFAULT 1            -- 是否启用
);
```

## API 接口

| 方法 | 路径 | 说明 | 需要认证 |
|------|------|------|----------|
| GET | `/api/health` | 健康检查 | 否 |
| POST | `/api/verify` | 验证访问秘钥 | 否 |
| GET | `/api/context` | 获取报告上下文数据 | 是 |
| GET | `/api/tools_prompt` | 获取工具提示词数据 | 是 |
| POST | `/api/chat` | 聊天接口（流式） | 是 |
| POST | `/api/chat/sync` | 聊天接口（同步） | 是 |

### 接口参数说明

**GET /api/context**
- `report_id` (可选): 报告ID，用于获取特定报告的上下文

**GET /api/tools_prompt**
- `prompt_id` (可选): 提示词ID，默认为 'default_tools_prompt'

### 认证方式

需要认证的接口支持以下两种方式传递秘钥：

1. **X-Access-Key 头部**
```
X-Access-Key: your-access-key
```

2. **Authorization Bearer 头部**
```
Authorization: Bearer your-access-key
```

## 配置上下文数据

### 报告上下文 `context_data.json`

```json
{
  "system": "你是一个专业的助手，下面是本次报告的内容，需要报告内容来回答问题。",
  "context": {
    "report_metadata": {
      "title": "报告标题",
      "project_name": "项目名称"
    },
    "analysis_modules": {
      // 分析模块数据
    }
  },
  "instructions": "回答问题时要考虑报告内容，对于超出范围的问题要明确告知用户。"
}
```

### 工具提示词 `tools_prompt.json`

```json
{
  "tools_system_prompt": "你是一个专业的生物信息学分析助手...",
  "recommendation_instructions": "推荐分析时请遵循以下原则...",
  "单细胞RNA分析工具": {
    "基础处理模块": {
      "loadData": {
        "description": "数据加载模块",
        "recommendation": "如果您有新的单细胞数据需要分析..."
      }
      // 更多工具...
    }
    // 更多模块...
  },
  "单细胞空间转录组分析工具": {
    // 空间转录组分析工具...
  }
}
```

## 前端配置

修改 `ai助手最新样式后台.html` 中的配置：

```javascript
const API_CONFIG = {
  BACKEND_URL: 'http://your-server:8100/api',  // 修改为实际地址
  CHAT_ENDPOINT: '/chat',
  CONTEXT_ENDPOINT: '/context',
  TOOLS_PROMPT_ENDPOINT: '/tools_prompt',
  HEALTH_ENDPOINT: '/health',
  VERIFY_KEY_ENDPOINT: '/verify'
};

// 报告唯一标识（生成报告时替换）
const REPORT_ID = 'LUAD_2025_001';
```

## 数据流程

```
用户打开页面 → 验证秘钥
  → 并行获取:
      1. contextData (报告上下文)
      2. toolsPromptData (工具提示词)
  → 整合为统一的 system prompt:
      - 角色设定 (tools_system_prompt)
      - 报告数据 (contextData.context)
      - 可用分析模块 (tools_data)
      - 分析推荐原则 (recommendation_instructions)
      - 回答要求 (instructions)
  → 用户提问 → DeepSeek 回答
```

## Nginx 反向代理配置（可选）

```nginx
location /api/ {
    proxy_pass http://127.0.0.1:8100/api/;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_buffering off;  # 重要：禁用缓冲以支持流式响应
}
```

## 常见问题

### 1. 跨域问题
后台已启用 CORS，如果仍有问题，检查 nginx 配置。

### 2. 流式响应不工作
确保 nginx 配置了 `proxy_buffering off`。

### 3. API Key 错误
检查环境变量 `DEEPSEEK_API_KEY` 是否正确设置。

### 4. 数据库连接失败
- MySQL: 检查 MySQL 服务是否启动，用户名密码是否正确
- SQLite: 确保数据库文件路径正确且有写入权限
