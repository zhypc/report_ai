# AI助手后台服务启动说明

## 文件说明

```
backend_server.py    # 后台服务主程序
requirements.txt     # Python 依赖
context_data.json    # 上下文数据配置（可选）
```

## 快速启动

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 配置环境变量

```bash
# 必须：DeepSeek API Key
export DEEPSEEK_API_KEY='sk-your-api-key-here'

# 必须：访问秘钥（多个秘钥用逗号分隔）
export VALID_ACCESS_KEYS='key1,key2,key3'

# 可选：服务器配置
export SERVER_HOST='0.0.0.0'
export SERVER_PORT='8100'
export DEBUG_MODE='false'

# 可选：上下文数据文件路径
export CONTEXT_FILE_PATH='context_data.json'
```

### 3. 启动服务

**开发环境：**
```bash
python backend_server.py
```

**生产环境（使用 gunicorn）：**
```bash
gunicorn -w 4 -b 0.0.0.0:8100 backend_server:app
```

## API 接口

| 方法 | 路径 | 说明 | 需要认证 |
|------|------|------|----------|
| GET | `/api/health` | 健康检查 | 否 |
| POST | `/api/verify` | 验证访问秘钥 | 否 |
| GET | `/api/context` | 获取上下文数据 | 是 |
| POST | `/api/chat` | 聊天接口（流式） | 是 |
| POST | `/api/chat/sync` | 聊天接口（同步） | 是 |

### 认证方式

需要认证的接口支持以下两种方式传递秘钥：

1. **X-Access-Key 头部**
```
X-Access-Key: your-access-key
```

2. **Authorization Bearer 头部**
```
Authorization: Bearer your-access-key
```

## 配置上下文数据

创建 `context_data.json` 文件：

```json
{
  "system": "你是一个专业的助手，下面是本次报告的内容，需要报告内容来回答问题。",
  "context": {
    "report_metadata": {
      "title": "报告标题",
      "project_name": "项目名称"
    },
    "analysis_modules": {
      // 分析模块数据
    }
  },
  "instructions": "回答问题时要考虑报告内容，对于超出范围的问题要明确告知用户。"
}
```

## 前端配置

修改 `ai助手最新样式后台.html` 中的 API 地址：

```javascript
const API_CONFIG = {
  BACKEND_URL: 'http://your-server:8100/api',  // 修改为实际地址
  // ...
};
```

## Nginx 反向代理配置（可选）

```nginx
location /api/ {
    proxy_pass http://127.0.0.1:8100/api/;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_buffering off;  # 重要：禁用缓冲以支持流式响应
}
```

## 常见问题

### 1. 跨域问题
后台已启用 CORS，如果仍有问题，检查 nginx 配置。

### 2. 流式响应不工作
确保 nginx 配置了 `proxy_buffering off`。

### 3. API Key 错误
检查环境变量 `DEEPSEEK_API_KEY` 是否正确设置。
