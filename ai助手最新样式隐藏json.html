<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Á©∫ HTML</title>
  
</head>

<body>
  <script id="hidden-json-data" type="application/json">
ewogICAgInN5c3RlbSI6ICLkvaDmmK/kuIDkuKrkuJPkuJrnmoTliqnmiYvvvIzkuIvpnaLmmK/mnKzmrKHmiqXlkYrnmoTlhoXlrrnvvIzpnIDopoHmiqXlkYrlhoXlrrnmnaXlm57nrZTpl67popjjgIIiLAogICAgImNvbnRleHQiOiB7CiAgInJlcG9ydF9tZXRhZGF0YSI6IHsKICAgICJ0aXRsZSI6ICLnqbrpl7TovazlvZXnu4Tmt7HluqbliIbmnpDmiqXlkYoiLAogICAgInByb2plY3RfbmFtZSI6ICJyZXBvcnTkuK3lop7liqBhaeWKqeaJi+a1i+ivlemhueebriIsCiAgICAic2FtcGxlX2luZm8iOiB7CiAgICAgICJzYW1wbGVfaWQiOiAiTFVBRF9TMSwgTFVBRF9TMiIsCiAgICAgICJzbGlkZV9pZCI6ICJMVUFEX1MxLCBMVUFEX1MyIiwKICAgICAgInNwZWNpZXMiOiAiaHMiLAogICAgICAidGlzc3VlX3R5cGUiOiAi6IK66YOoIgogICAgfSwKICAgICJhbmFseXNpc19kYXRlIjogIjIwMjUtMTEtMTciLAogICAgInBpcGVsaW5lX3ZlcnNpb24iOiAi5rex5bqm5YiG5p6QIgogIH0sCiAgImFuYWx5c2lzX21vZHVsZXMiOiB7CiAgICAiMV8wX2xvYWREYXRhIjogewogICAgICAibW9kdWxlX25hbWUiOiAi5pWw5o2u5Yqg6L29IiwKICAgICAgImRlc2NyaXB0aW9uIjogIuWOn+Wni+aVsOaNruWKoOi9veWSjOagvOW8j+i9rOaNoiIsCiAgICAgICJvdXRwdXRfc3VtbWFyeSI6ICLliqDovb3kuoYyNzgzMjjkuKrnu4bog57vvIw2NzM45Liq5Z+65ZugIiwKICAgICAgImtleV9tZXRyaWNzIjogewogICAgICAgICJ0b3RhbF9jZWxscyI6IDI3ODMyOCwKICAgICAgICAidG90YWxfZ2VuZXMiOiA2NzM4CiAgICAgIH0KICAgICAgCiAgICB9LAogICAgIjFfMV9xY0RhdGEiOiB7CiAgICAgICJtb2R1bGVfbmFtZSI6ICLotKjph4/mjqfliLYiLAogICAgICAiZGVzY3JpcHRpb24iOiAi5pWw5o2u6LSo6YeP6K+E5Lyw5ZKM6L+H5rukIiwKICAgICAgIm91dHB1dF9zdW1tYXJ5IjogIui/h+a7pOWQjuWJqeS9mTI3ODMyOOS4que7huiDnu+8jDY3MzjkuKrln7rlm6AiLAogICAgICAia2V5X21ldHJpY3MiOiB7CiAgICAgICAgImZpbHRlcmVkX2NlbGxzIjogMCwKICAgICAgICAiZmlsdGVyZWRfZ2VuZXMiOiAwLAogICAgICAgICJtaXRvX3JhdGlvX3RocmVzaG9sZCI6IDAsCiAgICAgICAgImRvdWJsZXRfc2NvcmVfdGhyZXNob2xkIjogMAogICAgICB9CiAgICB9LAogICAgIjFfMl9wcmVwcm9jZXNzRGF0YSI6IHsKICAgICAgIm1vZHVsZV9uYW1lIjogIuaVsOaNrumihOWkhOeQhiIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICLmoIflh4bljJbjgIHlvZLkuIDljJbjgIHmibnmrKHmoKHmraMiLAogICAgICAib3V0cHV0X3N1bW1hcnkiOiAi5a6M5oiQ5qCH5YeG5YyW5ZKM5om55qyh5qCh5q2jIiwKICAgICAgImtleV9tZXRyaWNzIjogewogICAgICAgICJub3JtYWxpemF0aW9uX21ldGhvZCI6ICJMb2dOb3JtYWxpemUiLAogICAgICAgICJuRmVhdHVyZXMiOiAzMDAwCiAgICAgIH0KICAgIH0sCiAgICAiMV8zX3BjYURhdGEiOiB7CiAgICAgICJtb2R1bGVfbmFtZSI6ICJQQ0HliIbmnpAiLAogICAgICAiZGVzY3JpcHRpb24iOiAi5Li75oiQ5YiG5YiG5p6QIiwKICAgICAgIm91dHB1dF9zdW1tYXJ5IjogIuWujOaIkOS6hlBDQeS4u+aIkOWIhuWIhuaekCIsCiAgICAgICJrZXlfbWV0cmljcyI6IHsKICAgICAgICAibl9wY3MiOiA0MAogICAgICB9CiAgICB9LAogICAgIjFfNF9pbnRlZ3JhdGVEYXRhIjogewogICAgICAibW9kdWxlX25hbWUiOiAi5pWw5o2u5pW05ZCIIiwKICAgICAgImRlc2NyaXB0aW9uIjogIuWkmuagt+acrC/lpJrljLrln5/mlbDmja7mlbTlkIgiLAogICAgICAib3V0cHV0X3N1bW1hcnkiOiAi5a6M5oiQ5pWw5o2u5pW05ZCI77yM6K+G5Yir5om55qyh5pWI5bqUIiwKICAgICAgImtleV9tZXRyaWNzIjogewogICAgICAgICJpbnRlZ3JhdGlvbl9tZXRob2QiOiAiSGFybW9ueSIsCiAgICAgICAgImRpbV91c2UiOiAzMCwKICAgICAgICAiay53ZWlnaHQiOiA1MAogICAgICB9CiAgICB9LAogICAgIjFfNV9jbHVzdGVyUmVkdWN0aW9uRGF0YSI6IHsKICAgICAgIm1vZHVsZV9uYW1lIjogIuiBmuexu+mZjee7tCIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICLpmY3nu7TogZrnsbvliIbmnpAiLAogICAgICAib3V0cHV0X3N1bW1hcnkiOiAi6K+G5YirMTXkuKrnu4bog57nvqQiLAogICAgICAia2V5X21ldHJpY3MiOiB7CiAgICAgICAgIm5fY2x1c3RlcnMiOiAxMiwKICAgICAgICAiRmluZENsdXN0ZXJzX3Jlc29sdXRpb24iOiAwLjIsCiAgICAgICAgIm4ubmVpZ2hib3JzIjogMzAKICAgICAgfQogICAgfSwKICAgICIyXzFfbGFiZWxUcmFuc2ZlciI6IHsKICAgICAgIm1vZHVsZV9uYW1lIjogIue7huiDnuexu+Wei+azqOmHiiIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICLln7rkuo7lj4LogIPmlbDmja7pm4bnmoTnu4bog57nsbvlnovms6jph4oiLAogICAgICAib3V0cHV0X3N1bW1hcnkiOiAi5rOo6YeK5LqGNDDkuKrnu4bog57nvqTnmoTnsbvlnosiLAogICAgICAia2V5X21ldHJpY3MiOiB7CiAgICAgICAgInJlZmVyZW5jZV9kYXRhc2V0IjogIkdTRTEzMTkwN19MdW5nX0NhbmNlcl9maW5hbF90THVuZyIsCiAgICAgICAgInNjX2Rvd25TYW1wbGVfbnVtIjogMTAwCiAgICAgIH0sCiAgICAgICJhbm5vdGF0aW9uX3Jlc3VsdHMiOiB7CiAgICAgICAgImNsdXN0ZXJfMCI6IHsidHlwZSI6ICJGaWJyb2JsYXN0cyIsICJjb25maWRlbmNlIjogMC45Mn0sCiAgICAgICAgImNsdXN0ZXJfMSI6IHsidHlwZSI6ICJFbmRvdGhlbGlhbCBjZWxscyIsICJjb25maWRlbmNlIjogMC44OH0KICAgICAgfQogICAgfSwKICAgICIyXzJfc3RSQ1REIjogewogICAgICAibW9kdWxlX25hbWUiOiAi56m66Ze06Kej5Y2356evIiwKICAgICAgImRlc2NyaXB0aW9uIjogIuepuumXtOihqOi+vuaVsOaNrueahOe7huiDnuexu+Wei+ino+WNt+enryIsCiAgICAgICJvdXRwdXRfc3VtbWFyeSI6ICLms6jph4rkuoYzNuS4que7huiDnue+pOeahOexu+WeiyIsCiAgICAgICJrZXlfbWV0cmljcyI6IHsKICAgICAgICAiZG91YmxldF9tb2RlIjogImRvdWJsZXQiCiAgICAgIH0KICAgIH0sCiAgICAiM18xX0J1aWxkTmljaGVBc3NheSI6IHsKICAgICAgIm1vZHVsZV9uYW1lIjogIueUn+aAgeS9jeWIhuaekCIsCiAgICAgICJkZXNjcmlwdGlvbiI6ICLmnoTlu7rnlJ/mgIHkvY3lubbliIbmnpDnu4bog57nm7jkupLkvZznlKgiLAogICAgICAib3V0cHV0X3N1bW1hcnkiOiAi5p6E5bu65LqGNOS4queUn+aAgeS9jSIsCiAgICAgICJrZXlfbWV0cmljcyI6IHsKICAgICAgICAibmVpZ2hib3JzLmsiOiAyMAogICAgICB9CiAgICB9LAogICAgIjNfMl9DZWxsQ2hhdDIiOiB7CiAgICAgICJtb2R1bGVfbmFtZSI6ICLnu4bog57pgJrorq/liIbmnpAiLAogICAgICAiZGVzY3JpcHRpb24iOiAi5YiG5p6Q57uG6IOe6Ze055qE6YCa6K6v572R57ucIiwKICAgICAgIm91dHB1dF9zdW1tYXJ5IjogIuivhuWIq+S6hjExMeS4quaYvuiRl+eahOe7huiDnumAmuiur+WvuSIsCiAgICAgICJrZXlfbWV0cmljcyI6IHsKICAgICAgICAic2lnbmFsaW5nX3BhaXJzIjogMTIwCiAgICAgICAgCiAgICAgIH0KICAgIH0KICB9CiAgCn0sCiAgICAiaW5zdHJ1Y3Rpb25zIjogIuWbnuetlOmXrumimOaXtuimgeiAg+iZkeaKpeWRiuWGheWuue+8jOWvueS6jui2heWHuuiMg+WbtOeahOmXrumimOimgeaYjuehruWRiuefpeeUqOaIt++8jOWbnuetlOmXrumimOS4jeimgeS9v+eUqE1hcmtkb3du5qC85byP44CCIgogIH0K
</script>
  <div id="ai-chat-container">
    <button id="ai-chat-toggle" onclick="toggleChat()">
      üí¨
    </button>

    <div id="ai-chat-window" style="display: none;">
      <div id="ai-chat-header">
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 24px;">ü§ñ</span>
          <div>
            <div style="font-size: 16px; font-weight: bold;">DeepSeek AI Âä©Êâã</div>
            <div style="font-size: 11px; opacity: 0.9; font-weight: normal;">Êô∫ËÉΩÈóÆÁ≠îÂä©Êâã</div>
          </div>
        </div>
        <button onclick="toggleChat()"
          style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; opacity: 0.9; transition: opacity 0.2s;"
          onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'">√ó</button>
      </div>

      <div id="ai-api-key-section">
        <div style="width: 100%;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: #555;">
            <span style="font-size: 16px;">üîë</span>
            <span style="font-size: 13px; font-weight: 500;">ËæìÂÖ•ÊÇ®ÁöÑ API Key</span>
          </div>
          <div style="display: flex; gap: 10px;">
            <input type="password" id="ai-api-key" placeholder="sk-..." />
            <button onclick="saveApiKey()">
              <span style="font-size: 16px;">‚úì</span>
            </button>
          </div>
          <div class="api-key-status" id="api-key-status">Êú™ÈÖçÁΩÆAPIÂØÜÈí•</div>
        </div>
      </div>

      <div id="ai-chat-messages"></div>

      <div id="ai-default-questions">
        <div class="default-questions-title">ÊÇ®ÂèØ‰ª•ËøôÊ†∑ÈóÆÊàëÔºö</div>
        <div class="default-question-btn" onclick="askDefaultQuestion('Ëøô‰ªΩÊä•ÂëäÂàÜÊûê‰∫ÜÂ§öÂ∞ë‰∏™ÁªÜËÉûÂíåÂü∫Âõ†Ôºü')">Ëøô‰ªΩÊä•ÂëäÂàÜÊûê‰∫ÜÂ§öÂ∞ë‰∏™ÁªÜËÉûÂíåÂü∫Âõ†Ôºü</div>
        <div class="default-question-btn" onclick="askDefaultQuestion('Êä•Âëä‰∏≠ËØÜÂà´‰∫ÜÂì™‰∫õÁªÜËÉûÁ±ªÂûãÔºü')">Êä•Âëä‰∏≠ËØÜÂà´‰∫ÜÂì™‰∫õÁªÜËÉûÁ±ªÂûãÔºü</div>
        <div class="default-question-btn" onclick="askDefaultQuestion('ËØ∑ÊÄªÁªì‰∏Ä‰∏ãËøô‰ªΩÊä•ÂëäÁöÑ‰∏ªË¶ÅÂèëÁé∞')">ËØ∑ÊÄªÁªì‰∏Ä‰∏ãËøô‰ªΩÊä•ÂëäÁöÑ‰∏ªË¶ÅÂèëÁé∞</div>
      </div>

      <div id="ai-chat-input-section">
        <textarea id="ai-user-input" placeholder="üí≠ ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢ò..." rows="3"></textarea>
        <button id="ai-send-btn" onclick="sendMessage()">
          <span style="font-size: 18px;">‚û§</span>
        </button>
      </div>
    </div>
    <!-- Âä†ËΩΩÊåáÁ§∫Âô® -->
    <div id="loading-indicator"
      class="hidden absolute bottom-20 left-1/2 transform -translate-x-1/2 flex items-center space-x-2">
      <div class="w-2 h-2 rounded-full bg-primary animate-bounce [animation-delay:-0.3s]"></div>
      <div class="w-2 h-2 rounded-full bg-primary animate-bounce [animation-delay:-0.15s]"></div>
      <div class="w-2 h-2 rounded-full bg-primary animate-bounce"></div>
    </div>
  </div>

  <style>
    .api-key-status {
      font-size: 11px;
      color: #666;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .api-key-status.success {
      color: #4caf50;
    }

    .api-key-status.error {
      color: #f44336;
    }

    #ai-chat-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    #ai-chat-toggle {
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
      z-index: 9999;
      transition: transform 0.3s, box-shadow 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #ai-chat-toggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(102, 126, 234, 0.5);
    }

    #ai-chat-toggle:active {
      transform: translateY(0);
    }

    #ai-chat-window {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 400px;
      max-height: 550px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      z-index: 10000;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #ai-chat-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    #ai-api-key-section {
      padding: 20px;
      background: linear-gradient(to bottom, #f8f9ff 0%, #ffffff 100%);
      border-bottom: 1px solid #e0e7ff;
    }

    #ai-api-key {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e0e7ff;
      border-radius: 12px;
      font-size: 14px;
      font-family: 'Courier New', monospace;
      transition: all 0.3s;
      background: white;
    }

    #ai-api-key:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    #ai-api-key-section button {
      padding: 12px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    #ai-api-key-section button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }

    #ai-api-key-section button:active {
      transform: translateY(0);
    }

    #ai-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: linear-gradient(to bottom, #fafbff 0%, #f5f7ff 100%);
      scroll-behavior: smooth;
    }

    #ai-chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    #ai-chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }

    #ai-chat-messages::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 3px;
    }

    #ai-chat-messages::-webkit-scrollbar-thumb:hover {
      background: #a0aec0;
    }

    .ai-message {
      margin-bottom: 16px;
      padding: 14px 18px;
      border-radius: 18px;
      left: 20px;
      max-width: 85%;
      word-wrap: break-word;
      line-height: 1.5;
      animation: messageSlide 0.3s ease-out;
      position: relative;
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .ai-user-message {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 4px;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .ai-bot-message {
      background: white;
      color: #2d3748;
      margin-right: auto;
      border: 1px solid #e2e8f0;
      border-bottom-left-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .ai-bot-message::before {
      content: 'ü§ñ';
      position: absolute;
      left: -35px;
      top: 0;
      font-size: 24px;
    }

    .ai-error-message {
      background: linear-gradient(135deg, #fc5c7d 0%, #6a82fb 100%);
      color: white;
      margin-right: auto;
      border-bottom-left-radius: 4px;
      box-shadow: 0 4px 12px rgba(252, 92, 125, 0.3);
    }

    .ai-error-message::before {
      content: '‚ö†Ô∏è';
      position: absolute;
      left: -32px;
      top: 0;
      font-size: 24px;
    }

    .ai-loading {
      background: white;
      color: #718096;
      margin-right: auto;
      border: 1px solid #e2e8f0;
      font-style: italic;
      border-bottom-left-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .ai-loading::after {
      content: '';
      display: inline-block;
      width: 4px;
      height: 16px;
      background: #718096;
      margin-left: 4px;
      animation: blink 1s infinite;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 0;
      }

      50% {
        opacity: 1;
      }
    }

    #ai-chat-input-section {
      padding: 20px;
      background: white;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 12px;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
    }

    #ai-default-questions {
      padding: 12px 20px;
      background: linear-gradient(to bottom, #f5f7ff 0%, #fafbff 100%);
      border-top: 1px solid #e2e8f0;
    }

    .default-questions-title {
      font-size: 12px;
      color: #718096;
      margin-bottom: 10px;
      font-weight: 500;
    }

    .default-question-btn {
      display: inline-block;
      padding: 8px 14px;
      margin: 4px 6px 4px 0;
      background: white;
      border: 1px solid #e0e7ff;
      border-radius: 20px;
      font-size: 13px;
      color: #667eea;
      cursor: pointer;
      transition: all 0.2s;
    }

    .default-question-btn:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: transparent;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    #ai-user-input {
      flex: 1;
      padding: 14px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 16px;
      font-size: 14px;
      resize: none;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      transition: all 0.3s;
      background: #fafbff;
    }

    #ai-user-input:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    #ai-user-input::placeholder {
      color: #a0aec0;
    }

    #ai-send-btn {
      padding: 14px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      font-size: 14px;
      white-space: nowrap;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 56px;
    }

    #ai-send-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }

    #ai-send-btn:active:not(:disabled) {
      transform: translateY(0);
    }

    #ai-send-btn:disabled {
      background: linear-gradient(135deg, #cbd5e0 0%, #a0aec0 100%);
      cursor: not-allowed;
      box-shadow: none;
    }

    @media (max-width: 480px) {
      #ai-chat-window {
        width: 100%;
        height: 100%;
        bottom: 0;
        right: 0;
        border-radius: 0;
      }

      #ai-chat-toggle {
        bottom: 16px;
        right: 16px;
      }
    }
  </style>

  <script>

    const hiddenJsonMeta = document.getElementById('hidden-json-data').textContent.trim();
    const hiddenJsonData = JSON.parse(decodeURIComponent(escape(window.atob(hiddenJsonMeta))));

    let aiApiKey = localStorage.getItem('deepseek_api_key') || '';
    let chatHistory = [];
    const loadingIndicator = document.getElementById('loading-indicator');

    /**
     * Ê£ÄÊü•DeepSeek APIÂØÜÈí•ÊòØÂê¶ÊúâÊïà
     * @param {string} apiKey - DeepSeek APIÂØÜÈí•
     * @returns {Promise<{valid: boolean, message: string}>} È™åËØÅÁªìÊûú
    */
    async function checkDeepSeekApiKey(apiKey) {
      if (!apiKey) {
        return { valid: false, message: 'APIÂØÜÈí•‰∏çËÉΩ‰∏∫Á©∫' };
      }

      try {
        // Ë∞ÉÁî®DeepSeekÁöÑÊ®°ÂûãÂàóË°®Êé•Âè£‰Ωú‰∏∫È™åËØÅÔºàÊó†ÈúÄÈ¢ùÂ§ñÂèÇÊï∞ÔºåÈÄÇÂêàÊµãËØïÔºâ
        const response = await fetch('https://api.deepseek.com/v1/models', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.ok) {
          // ÂìçÂ∫îÊàêÂäüÔºåÂØÜÈí•ÊúâÊïà
          return { valid: true, message: 'APIÂØÜÈí•ÊúâÊïà' };
        } else if (response.status === 401) {
          // 401ÈÄöÂ∏∏Ë°®Á§∫Êú™ÊéàÊùÉÔºàÂØÜÈí•Êó†ÊïàÊàñËøáÊúüÔºâ
          return { valid: false, message: 'APIÂØÜÈí•Êó†ÊïàÊàñÂ∑≤ËøáÊúü' };
        } else if (response.status === 429) {
          // 429Ë°®Á§∫ËØ∑Ê±ÇÈ¢ëÁéáË∂ÖÈôêÔºà‰ΩÜÂØÜÈí•Êú¨Ë∫´ÊúâÊïàÔºâ
          return { valid: true, message: 'APIÂØÜÈí•ÊúâÊïàÔºå‰ΩÜËØ∑Ê±ÇÈ¢ëÁéáË∂ÖÈôê' };
        } else {
          // ÂÖ∂‰ªñÈîôËØØÁä∂ÊÄÅ
          const errorData = await response.json().catch(() => ({}));
          return {
            valid: false,
            message: `È™åËØÅÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†Å: ${response.status}ÔºåÂéüÂõ†: ${errorData.error?.message || 'Êú™Áü•ÈîôËØØ'}`
          };
        }
      } catch (error) {
        // ÁΩëÁªúÈîôËØØÁ≠âÂºÇÂ∏∏ÊÉÖÂÜµ
        return {
          valid: false,
          message: `ËØ∑Ê±ÇÂ§±Ë¥•: ${error.message || 'ÁΩëÁªúÈîôËØØÊàñÊúçÂä°‰∏çÂèØÁî®'}`
        };
      }
    }

    /**
   * Âà§Êñ≠ÂèòÈáèÊòØÂê¶‰∏∫ÊúâÊïàÁöÑ JSON Ê†ºÂºèÂ≠óÁ¨¶‰∏≤
   * @param {any} variable - ÈúÄË¶ÅÂà§Êñ≠ÁöÑÂèòÈáè
   * @returns {boolean} ÊòØÊúâÊïà JSON Â≠óÁ¨¶‰∏≤ÂàôËøîÂõû trueÔºåÂê¶ÂàôËøîÂõû false
   */
    function isJsonString(variable) {
      // Á¨¨‰∏ÄÊ≠•ÔºöÂÖàÂà§Êñ≠ÊòØÂê¶‰∏∫Â≠óÁ¨¶‰∏≤Á±ªÂûã
      if (typeof variable !== 'string') {
        return false;
      }

      try {
        // Á¨¨‰∫åÊ≠•ÔºöÂ∞ùËØïËß£ÊûêÂ≠óÁ¨¶‰∏≤
        const parsed = JSON.parse(variable);
        // È¢ùÂ§ñÂà§Êñ≠ÔºöËß£ÊûêÁªìÊûúÂøÖÈ°ªÊòØÂØπË±°ÊàñÊï∞ÁªÑÔºàJSON Ê†πÁªìÊûÑÂè™ËÉΩÊòØÂØπË±°ÊàñÊï∞ÁªÑÔºâ
        return typeof parsed === 'object' && parsed !== null;
      } catch (error) {
        // Ëß£ÊûêÂ§±Ë¥•ÔºåËØ¥Êòé‰∏çÊòØÊúâÊïàÁöÑ JSON
        return false;
      }
    }
    // ÂàùÂßãÂåñËÅäÂ§©ÂéÜÂè≤ÔºåÂåÖÂê´ÈöêËóèÁöÑJSONÊï∞ÊçÆ‰Ωú‰∏∫Á≥ªÁªüÊèêÁ§∫
    function initializeChatHistory() {
      const history = [];
      history.push({
        role: 'system',
        content: hiddenJsonData.system
      });

      // ÈÅçÂéÜJSONÁöÑÊØè‰∏™key
      jsonContext = hiddenJsonData.context;
      for (const key1 in jsonContext) {
        for (const key2 in jsonContext[key1]) {
          info = jsonContext[key1][key2];
          if(typeof info === 'object'){
            info = JSON.stringify(info, null, 2);
          }
          const systemPrompt = info; // Ëé∑Âèñvalue‰Ωú‰∏∫systemPrompt
          history.push({
            role: 'system',
            content: systemPrompt
          });
        }
      }
      history.push({
        role: 'system',
        content: hiddenJsonData.instructions
      });
      return history;
        // try {
        //   // ÂèëÈÄÅËØ∑Ê±ÇÂà∞DeepSeek APIÔºàÊõøÊç¢‰∏∫ÂÆûÈôÖAPIÂú∞ÂùÄÔºâ
        //   const response = await fetch("https://api.deepseek.com/chat/completions", {
        //     method: "POST",
        //     headers: {
        //       "Content-Type": "application/json",
        //       "Authorization": "Bearer YOUR_API_KEY" // ÊõøÊç¢‰∏∫‰Ω†ÁöÑAPIÂØÜÈí•
        //     },
        //     body: JSON.stringify(requestData)
        //   });

        //   const result = await response.json();
        //   if (result.choices && result.choices.length > 0) {
        //     // Â∞ÜDeepSeekÁöÑÂõûÂ§çÊ∑ªÂä†Âà∞ÂéÜÂè≤ÂØπËØù
        //     history.push({
        //       role: "assistant",
        //       content: result.choices[0].message.content
        //     });
        //     console.log(`Â§ÑÁêÜkey: ${key} ÊàêÂäüÔºåÂõûÂ§ç:`, result.choices[0].message.content);
        //   }
        // } catch (error) {
        //   console.error(`Â§ÑÁêÜkey: ${key} Â§±Ë¥•:`, error);
        // }


      // Â∞ÜÈöêËóèÁöÑJSONÊï∞ÊçÆËΩ¨Êç¢‰∏∫Ëá™ÁÑ∂ËØ≠Ë®ÄÁ≥ªÁªüÊèêÁ§∫
      // const systemPrompt = `
      //   ${hiddenJsonData.system}

      //   Êä•ÂëäÂÜÖÂÆπÔºö
      //     ${report_data}

      //   ${hiddenJsonData.instructions}
      // `.trim();
      // return [
      //   {
      //     role: "system",
      //     content: systemPrompt
      //   }
      // ];
    }
    // È°µÈù¢Âä†ËΩΩÊó∂Ê£ÄÊü•ÊòØÂê¶Â∑≤‰øùÂ≠ò API Key
    window.addEventListener('load', async function () {
      if (aiApiKey) {
        result = await checkDeepSeekApiKey(aiApiKey);
        if (result.valid) {
          // ÂàùÂßãÂåñËÅäÂ§©ÂéÜÂè≤ÔºåÂåÖÂê´ÈöêËóèÁöÑJSONÊï∞ÊçÆ
          chatHistory = chatHistory.concat(initializeChatHistory());
          document.getElementById('ai-api-key-section').style.display = 'none';
          addMessage('ÊÇ®Â•ΩÔºÅÊàëÊòØAIÂä©ÊâãÔºåÂèØ‰ª•Â∏ÆÂä©ÊÇ®Ëß£Á≠îÂÖ≥‰∫éËøô‰ªΩÁ©∫Èó¥ËΩ¨ÂΩïÁªÑÂàÜÊûêÊä•ÂëäÁöÑÈóÆÈ¢ò„ÄÇÊúâ‰ªÄ‰πàÊàëÂèØ‰ª•Â∏ÆÊÇ®ÁöÑÂêóÔºü', 'bot');
        } else {
          updateApiKeyStatus(result.message, false);
          return;
        }


      }
    });

    function toggleChat() {
      const chatWindow = document.getElementById('ai-chat-window');
      const chatToggle = document.getElementById('ai-chat-toggle');

      if (chatWindow.style.display === 'none') {
        chatWindow.style.display = 'flex';
        chatToggle.style.display = 'none';
      } else {
        chatWindow.style.display = 'none';
        chatToggle.style.display = 'block';
      }
    }

    async function saveApiKey() {
      const apiKeyInput = document.getElementById('ai-api-key');
      aiApiKey = apiKeyInput.value.trim();

      if (!aiApiKey) {
        updateApiKeyStatus("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑAPIÂØÜÈí•", false);
        return;
      }


      result = await checkDeepSeekApiKey(aiApiKey);
      if (result.valid) {
        localStorage.setItem('deepseek_api_key', aiApiKey);
        chatHistory = chatHistory.concat(initializeChatHistory());
        document.getElementById('ai-api-key-section').style.display = 'none';
        addMessage('ÊÇ®Â•ΩÔºÅÊàëÊòØAIÂä©ÊâãÔºåÂèØ‰ª•Â∏ÆÂä©ÊÇ®Ëß£Á≠îÂÖ≥‰∫éËøô‰ªΩÁ©∫Èó¥ËΩ¨ÂΩïÁªÑÂàÜÊûêÊä•ÂëäÁöÑÈóÆÈ¢ò„ÄÇÊúâ‰ªÄ‰πàÊàëÂèØ‰ª•Â∏ÆÊÇ®ÁöÑÂêóÔºü', 'bot');
      } else {
        updateApiKeyStatus(result.message, false);
        return;
      }


    }

    function updateApiKeyStatus(message, isSuccess) {
      const statusElement = document.getElementById("api-key-status");
      if (statusElement) {
        statusElement.textContent = message;
        statusElement.className = "api-key-status " + (isSuccess ? "success" : "error");
      }
    }

    function addMessage(content, type) {
      const messagesDiv = document.getElementById('ai-chat-messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'ai-message';

      if (type === 'user') {
        messageDiv.classList.add('ai-user-message');
      } else if (type === 'bot') {
        messageDiv.classList.add('ai-bot-message');
      } else if (type === 'error') {
        messageDiv.classList.add('ai-error-message');
      } else if (type === 'loading') {
        messageDiv.classList.add('ai-loading');
        messageDiv.classList.add('ai-bot-message');
        messageDiv.id = 'loading-message';
      }

      messageDiv.textContent = content;
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      return messageDiv;
    }

    async function sendMessage() {
      if (!aiApiKey) {
        alert('ËØ∑ÂÖàËæìÂÖ•Âπ∂‰øùÂ≠ò DeepSeek API Key');
        document.getElementById('ai-api-key-section').style.display = 'flex';
        return;
      }

      const userInput = document.getElementById('ai-user-input');
      const message = userInput.value.trim();

      if (!message) {
        return;
      }
      // Ê∑ªÂä†systemPrompt
      // const systemPrompt = document.getElementById('hidden-json-data').getAttribute('data-info');
      // console.log('systemPrompt:', systemPrompt);
      // chatHistory.push({
      //   role: 'system',
      //   content: systemPrompt
      // });
      // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
      addMessage(message, 'user');
      chatHistory.push({
        role: 'user',
        content: message
      });

      userInput.value = '';

      // Á¶ÅÁî®ÂèëÈÄÅÊåâÈíÆ
      const sendBtn = document.getElementById('ai-send-btn');
      sendBtn.disabled = true;

      // ÊòæÁ§∫Âä†ËΩΩÊ∂àÊÅØ
      const loadingMsg = addMessage('Ê≠£Âú®ÊÄùËÄÉ‰∏≠...', 'loading');

      try {
        const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + aiApiKey
          },
          body: JSON.stringify({
            model: 'deepseek-chat',
            messages: chatHistory,
            temperature: 0.7,
            max_tokens: 2000
          })
        });



        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error?.message || 'ËØ∑Ê±ÇÂ§±Ë¥•: ' + response.status);
        }

        const data = await response.json();
        const assistantMessage = data.choices[0].message.content;

        // Ê∑ªÂä†Âä©ÊâãÂõûÂ§ç
        addMessage(assistantMessage, 'bot');
        chatHistory.push({
          role: 'assistant',
          content: assistantMessage
        });
        // ÁßªÈô§Âä†ËΩΩÊ∂àÊÅØ
        loadingMsg.remove();

      } catch (error) {
        // ÁßªÈô§Âä†ËΩΩÊ∂àÊÅØ
        if (document.getElementById('loading-message')) {
          document.getElementById('loading-message').remove();
        }

        addMessage('ÈîôËØØ: ' + error.message, 'error');
        console.error('DeepSeek API Error:', error);

        // Â¶ÇÊûúÊòØËÆ§ËØÅÈîôËØØ,ÊòæÁ§∫ API Key ËæìÂÖ•Ê°Ü
        if (error.message.includes('401') || error.message.includes('Unauthorized')) {
          document.getElementById('ai-api-key-section').style.display = 'flex';
          localStorage.removeItem('deepseek_api_key');
          aiApiKey = '';
        }
      } finally {
        sendBtn.disabled = false;
      }
    }

    // ÁÇπÂáªÈªòËÆ§ÈóÆÈ¢òÊåâÈíÆ
    function askDefaultQuestion(question) {
      if (!aiApiKey) {
        alert('ËØ∑ÂÖàËæìÂÖ•Âπ∂‰øùÂ≠ò DeepSeek API Key');
        document.getElementById('ai-api-key-section').style.display = 'flex';
        return;
      }
      document.getElementById('ai-user-input').value = question;
      // ÈöêËóèÈªòËÆ§ÈóÆÈ¢òÂå∫Âüü
      document.getElementById('ai-default-questions').style.display = 'none';
      sendMessage();
    }

    // ÊîØÊåÅÂõûËΩ¶ÂèëÈÄÅÊ∂àÊÅØ
    document.addEventListener('DOMContentLoaded', function () {
      const userInput = document.getElementById('ai-user-input');
      if (userInput) {
        userInput.addEventListener('keypress', function (e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      }
    });
  </script>
</body>

</html>