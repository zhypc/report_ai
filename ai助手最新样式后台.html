<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI æ™ºèƒ½åŠ©æ‰‹</title>
</head>

<body>
  <!-- ==================== é¡µé¢ç»“æ„éƒ¨åˆ† ==================== -->

  <!-- AIåŠ©æ‰‹ç»“æœå±•ç¤ºåŒºåŸŸï¼šç”¨äºåœ¨é¡µé¢ä¸»ä½“ä¸­å±•ç¤ºAIå›ç­”çš„å†…å®¹ -->
  <div id="ai-result-display"></div>

  <!-- ==================== AIèŠå¤©å®¹å™¨ ==================== -->
  <div id="ai-chat-container">

    <!-- èŠå¤©å¼€å¯æŒ‰é’®ï¼šç‚¹å‡»æ‰“å¼€èŠå¤©çª—å£ -->
    <button id="ai-chat-toggle" onclick="toggleChat()">
      ğŸ’¬
    </button>

    <!-- èŠå¤©çª—å£ä¸»ä½“ -->
    <div id="ai-chat-window" style="display: none;">

      <!-- èŠå¤©çª—å£å¤´éƒ¨ï¼šæ˜¾ç¤ºæ ‡é¢˜å’Œæ§åˆ¶æŒ‰é’® -->
      <div id="ai-chat-header">
        <!-- å·¦ä¾§ï¼šLogoå’Œæ ‡é¢˜ -->
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 24px;">ğŸ¤–</span>
          <div>
            <div style="font-size: 16px; font-weight: bold;">DeepSeek AI åŠ©æ‰‹</div>
            <div style="font-size: 11px; opacity: 0.9; font-weight: normal;">æ™ºèƒ½é—®ç­”åŠ©æ‰‹</div>
          </div>
        </div>
        <!-- å³ä¾§ï¼šæœ€å¤§åŒ–æŒ‰é’®å’Œå…³é—­æŒ‰é’® -->
        <div style="display: flex; align-items: center; gap: 8px;">
          <!-- æœ€å¤§åŒ–/è¿˜åŸæŒ‰é’® -->
          <button id="ai-maximize-btn" onclick="toggleMaximize()"
            style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; opacity: 0.9; transition: opacity 0.2s;"
            onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'">â›¶</button>
          <!-- å…³é—­æŒ‰é’® -->
          <button onclick="toggleChat()"
            style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; opacity: 0.9; transition: opacity 0.2s;"
            onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'">Ã—</button>
        </div>
      </div>

      <!-- è¿æ¥çŠ¶æ€æç¤ºåŒºåŸŸ -->
      <div id="ai-connection-status">
        <div style="width: 100%;">
          <div style="display: flex; align-items: center; gap: 8px; color: #555;">
            <span style="font-size: 16px;">ğŸ”—</span>
            <span style="font-size: 13px; font-weight: 500;">åå°è¿æ¥çŠ¶æ€</span>
          </div>
          <div class="connection-status" id="connection-status">æ­£åœ¨è¿æ¥åå°æœåŠ¡...</div>
        </div>
      </div>

      <!-- èŠå¤©æ¶ˆæ¯å±•ç¤ºåŒºåŸŸï¼šæ˜¾ç¤ºç”¨æˆ·å’ŒAIçš„å¯¹è¯ -->
      <div id="ai-chat-messages"></div>

      <!-- é»˜è®¤é—®é¢˜åŒºåŸŸï¼šå¯æŠ˜å çš„å¿«æ·é—®é¢˜æŒ‰é’® -->
      <div id="ai-default-questions">
        <!-- æŠ˜å æ ‡é¢˜æ ï¼šç‚¹å‡»å¯å±•å¼€/æ”¶èµ· -->
        <div class="default-questions-header" onclick="toggleDefaultQuestions()">
          <span class="default-questions-title">æ‚¨å¯ä»¥è¿™æ ·é—®æˆ‘ï¼š</span>
          <span id="default-questions-arrow">â–¼</span>
        </div>
        <!-- é»˜è®¤é—®é¢˜æŒ‰é’®åˆ—è¡¨ -->
        <div id="default-questions-content">
          <div class="default-question-btn" onclick="askDefaultQuestion('è¿™ä»½æŠ¥å‘Šåˆ†æäº†å¤šå°‘ä¸ªç»†èƒå’ŒåŸºå› ï¼Ÿ')">è¿™ä»½æŠ¥å‘Šåˆ†æäº†å¤šå°‘ä¸ªç»†èƒå’ŒåŸºå› ï¼Ÿ</div>
          <div class="default-question-btn" onclick="askDefaultQuestion('æŠ¥å‘Šä¸­è¯†åˆ«äº†å“ªäº›ç»†èƒç±»å‹ï¼Ÿ')">æŠ¥å‘Šä¸­è¯†åˆ«äº†å“ªäº›ç»†èƒç±»å‹ï¼Ÿ</div>
          <div class="default-question-btn" onclick="askDefaultQuestion('è¯·æ€»ç»“ä¸€ä¸‹è¿™ä»½æŠ¥å‘Šçš„ä¸»è¦å‘ç°')">è¯·æ€»ç»“ä¸€ä¸‹è¿™ä»½æŠ¥å‘Šçš„ä¸»è¦å‘ç°</div>
        </div>
      </div>

      <!-- ç”¨æˆ·è¾“å…¥åŒºåŸŸï¼šæ–‡æœ¬æ¡†å’Œå‘é€æŒ‰é’® -->
      <div id="ai-chat-input-section">
        <textarea id="ai-user-input" placeholder="ğŸ’­ è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." rows="3"></textarea>
        <button id="ai-send-btn" onclick="sendMessage()">
          <span style="font-size: 18px;">â¤</span>
        </button>
      </div>
    </div>

  </div>

  <!-- ==================== CSSæ ·å¼éƒ¨åˆ† ==================== -->
  <style>
    /* ---------- AIç»“æœå±•ç¤ºåŒºåŸŸæ ·å¼ ---------- */
    #ai-result-display {
      max-width: 800px;
      margin: 20px auto;
      padding: 0 20px;
    }

    .ai-result-paragraph {
      background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
      border-left: 4px solid #667eea;
      padding: 20px 24px;
      margin-bottom: 16px;
      border-radius: 0 12px 12px 0;
      box-shadow: 0 2px 12px rgba(102, 126, 234, 0.1);
      font-size: 15px;
      line-height: 1.8;
      color: #2d3748;
      animation: fadeIn 0.4s ease-out;
    }

    .ai-result-paragraph .result-title {
      font-weight: 600;
      color: #667eea;
      margin-bottom: 8px;
      font-size: 16px;
    }

    .ai-result-paragraph .result-content {
      color: #4a5568;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ---------- è¿æ¥çŠ¶æ€æ ·å¼ ---------- */
    #ai-connection-status {
      padding: 15px 20px;
      background: linear-gradient(to bottom, #f8f9ff 0%, #ffffff 100%);
      border-bottom: 1px solid #e0e7ff;
    }

    .connection-status {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .connection-status.success {
      color: #4caf50;
    }

    .connection-status.error {
      color: #f44336;
    }

    .connection-status.loading {
      color: #ff9800;
    }

    /* ---------- èŠå¤©å®¹å™¨æ ·å¼ ---------- */
    #ai-chat-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    #ai-chat-toggle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
      z-index: 9999;
      transition: transform 0.3s, box-shadow 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #ai-chat-toggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(102, 126, 234, 0.5);
    }

    #ai-chat-window {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 400px;
      max-height: 550px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      z-index: 10000;
      display: none;
      flex-direction: column;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    #ai-chat-window.maximized {
      bottom: 0;
      right: 0;
      width: 100%;
      height: 100%;
      max-height: 100%;
      border-radius: 0;
    }

    #ai-chat-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    #ai-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: linear-gradient(to bottom, #fafbff 0%, #f5f7ff 100%);
      scroll-behavior: smooth;
    }

    #ai-chat-messages::-webkit-scrollbar { width: 6px; }
    #ai-chat-messages::-webkit-scrollbar-track { background: transparent; }
    #ai-chat-messages::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 3px; }

    .ai-message {
      margin-bottom: 16px;
      padding: 14px 18px;
      border-radius: 18px;
      left: 20px;
      max-width: 85%;
      word-wrap: break-word;
      line-height: 1.5;
      animation: messageSlide 0.3s ease-out;
      position: relative;
    }

    @keyframes messageSlide {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .ai-user-message {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 4px;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .ai-bot-message {
      background: white;
      color: #2d3748;
      margin-right: auto;
      border: 1px solid #e2e8f0;
      border-bottom-left-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .ai-bot-message::before {
      content: 'ğŸ¤–';
      position: absolute;
      left: -35px;
      top: 0;
      font-size: 24px;
    }

    .ai-error-message {
      background: linear-gradient(135deg, #fc5c7d 0%, #6a82fb 100%);
      color: white;
      margin-right: auto;
      border-bottom-left-radius: 4px;
      box-shadow: 0 4px 12px rgba(252, 92, 125, 0.3);
    }

    .ai-error-message::before {
      content: 'âš ï¸';
      position: absolute;
      left: -32px;
      top: 0;
      font-size: 24px;
    }

    #ai-chat-input-section {
      padding: 20px;
      background: white;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 12px;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
    }

    #ai-default-questions {
      padding: 0;
      background: linear-gradient(to bottom, #f5f7ff 0%, #fafbff 100%);
      border-top: 1px solid #e2e8f0;
    }

    .default-questions-header {
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    .default-questions-header:hover {
      background: rgba(102, 126, 234, 0.05);
    }

    #default-questions-arrow {
      font-size: 12px;
      color: #718096;
      transition: transform 0.3s ease;
    }

    #default-questions-arrow.collapsed {
      transform: rotate(-90deg);
    }

    #default-questions-content {
      padding: 0 20px 12px 20px;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
      max-height: 200px;
    }

    #default-questions-content.collapsed {
      max-height: 0;
      padding-top: 0;
      padding-bottom: 0;
    }

    .default-questions-title {
      font-size: 12px;
      color: #718096;
      font-weight: 500;
    }

    .default-question-btn {
      display: inline-block;
      padding: 8px 14px;
      margin: 4px 6px 4px 0;
      background: white;
      border: 1px solid #e0e7ff;
      border-radius: 20px;
      font-size: 13px;
      color: #667eea;
      cursor: pointer;
      transition: all 0.2s;
    }

    .default-question-btn:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: transparent;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    #ai-user-input {
      flex: 1;
      padding: 14px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 16px;
      font-size: 14px;
      resize: none;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      transition: all 0.3s;
      background: #fafbff;
    }

    #ai-user-input:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    #ai-user-input::placeholder {
      color: #a0aec0;
    }

    #ai-send-btn {
      padding: 14px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      font-size: 14px;
      white-space: nowrap;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 56px;
    }

    #ai-send-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }

    #ai-send-btn:disabled {
      background: linear-gradient(135deg, #cbd5e0 0%, #a0aec0 100%);
      cursor: not-allowed;
      box-shadow: none;
    }

    @media (max-width: 480px) {
      #ai-chat-window {
        width: 100%;
        height: 100%;
        bottom: 0;
        right: 0;
        border-radius: 0;
      }
    }
  </style>

  <!-- ==================== JavaScripté€»è¾‘éƒ¨åˆ† ==================== -->
  <script>
    // ========== åå°APIé…ç½® ==========
    const API_CONFIG = {
      // åå°APIåœ°å€ï¼ˆéœ€è¦æ ¹æ®å®é™…éƒ¨ç½²ä¿®æ”¹ï¼‰
      BACKEND_URL: 'http://192.168.8.8:28100/api',
      // èŠå¤©æ¥å£
      CHAT_ENDPOINT: '/chat',
      // è·å–ä¸Šä¸‹æ–‡æ•°æ®æ¥å£
      CONTEXT_ENDPOINT: '/context',
      // å¥åº·æ£€æŸ¥æ¥å£
      HEALTH_ENDPOINT: '/health'
    };

    // æ¶ˆæ¯é•¿åº¦é™åˆ¶
    const MAX_MESSAGE_LENGTH = 2000;
    // èŠå¤©å†å²æœ€å¤§æ¡æ•°
    const MAX_CHAT_HISTORY = 50;
    // æ¬¢è¿æ¶ˆæ¯
    const WELCOME_MESSAGE = 'æ‚¨å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œå¯ä»¥å¸®åŠ©æ‚¨è§£ç­”å…³äºè¿™ä»½ç©ºé—´è½¬å½•ç»„åˆ†ææŠ¥å‘Šçš„é—®é¢˜ã€‚æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ';

    // ========== å…¨å±€å˜é‡ ==========
    let chatHistory = [];
    let isInitialized = false;
    let isBackendConnected = false;
    let contextData = null;

    // é—®é¢˜å…³é”®è¯åˆ—è¡¨
    const displayKeywords = ['ç»†èƒ', 'åŸºå› ', 'ç±»å‹', 'æ³¨é‡Š', 'èšç±»', 'ç»†èƒç¾¤', 'é€šè®¯', 'é€šä¿¡', 'ä¿¡å·', 'æ€»ç»“', 'å‘ç°', 'åˆ†æ'];

    // ========== é¡µé¢ç»“æœå±•ç¤º ==========
    function displayResultByQuestion(question, aiResponse) {
      for (const keyword of displayKeywords) {
        if (question.includes(keyword)) {
          showResultParagraph(question, aiResponse);
          return true;
        }
      }
      return false;
    }

    function showResultParagraph(question, content) {
      const displayDiv = document.getElementById('ai-result-display');
      const paragraph = document.createElement('div');
      paragraph.className = 'ai-result-paragraph';

      const titleDiv = document.createElement('div');
      titleDiv.className = 'result-title';
      titleDiv.textContent = question;

      const contentDiv = document.createElement('div');
      contentDiv.className = 'result-content';
      contentDiv.textContent = content;

      paragraph.appendChild(titleDiv);
      paragraph.appendChild(contentDiv);
      displayDiv.appendChild(paragraph);
      paragraph.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // ========== è¿æ¥çŠ¶æ€æ›´æ–° ==========
    function updateConnectionStatus(message, status) {
      const statusElement = document.getElementById('connection-status');
      if (statusElement) {
        statusElement.textContent = message;
        statusElement.className = 'connection-status ' + status;
      }
    }

    // ========== åå°APIè°ƒç”¨ ==========

    /**
     * æ£€æŸ¥åå°æœåŠ¡å¥åº·çŠ¶æ€
     */
    async function checkBackendHealth() {
      try {
        const response = await fetch(`${API_CONFIG.BACKEND_URL}${API_CONFIG.HEALTH_ENDPOINT}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });
        return response.ok;
      } catch (error) {
        console.error('Backend health check failed:', error);
        return false;
      }
    }

    /**
     * ä»åå°è·å–ä¸Šä¸‹æ–‡æ•°æ®ï¼ˆéšè—çš„JSONï¼‰
     */
    async function fetchContextData() {
      try {
        const response = await fetch(`${API_CONFIG.BACKEND_URL}${API_CONFIG.CONTEXT_ENDPOINT}`, {
          method: 'GET',
          headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
          throw new Error('è·å–ä¸Šä¸‹æ–‡æ•°æ®å¤±è´¥');
        }

        return await response.json();
      } catch (error) {
        console.error('Fetch context data failed:', error);
        throw error;
      }
    }

    /**
     * å‘é€èŠå¤©æ¶ˆæ¯åˆ°åå°ï¼ˆæµå¼å“åº”ï¼‰
     */
    async function sendChatToBackend(messages) {
      const response = await fetch(`${API_CONFIG.BACKEND_URL}${API_CONFIG.CHAT_ENDPOINT}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          messages: messages,
          stream: true
        })
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || 'è¯·æ±‚å¤±è´¥: ' + response.status);
      }

      return response;
    }

    // ========== èŠå¤©å†å²åˆå§‹åŒ– ==========
    function initializeChatHistory() {
      if (!contextData) return [];

      const history = [];

      // æ·»åŠ ç³»ç»Ÿè§’è‰²æç¤º
      if (contextData.system) {
        history.push({ role: 'system', content: contextData.system });
      }

      // éå†ä¸Šä¸‹æ–‡æ•°æ®
      if (contextData.context) {
        for (const key1 in contextData.context) {
          for (const key2 in contextData.context[key1]) {
            let info = contextData.context[key1][key2];
            if (typeof info === 'object') {
              info = JSON.stringify(info, null, 2);
            }
            history.push({ role: 'system', content: info });
          }
        }
      }

      // æ·»åŠ å›ç­”æŒ‡ä»¤
      if (contextData.instructions) {
        history.push({ role: 'system', content: contextData.instructions });
      }

      return history;
    }

    /**
     * åˆå§‹åŒ–èŠå¤©
     */
    async function initializeChat() {
      if (isInitialized) return;

      chatHistory = initializeChatHistory();
      isInitialized = true;

      // éšè—è¿æ¥çŠ¶æ€åŒºåŸŸ
      document.getElementById('ai-connection-status').style.display = 'none';
      // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
      addMessage(WELCOME_MESSAGE, 'bot');
    }

    // ========== é¡µé¢åŠ è½½äº‹ä»¶ ==========
    window.addEventListener('load', async function () {
      updateConnectionStatus('æ­£åœ¨è¿æ¥åå°æœåŠ¡...', 'loading');

      try {
        // æ£€æŸ¥åå°å¥åº·çŠ¶æ€
        const isHealthy = await checkBackendHealth();
        if (!isHealthy) {
          throw new Error('åå°æœåŠ¡ä¸å¯ç”¨');
        }

        // è·å–ä¸Šä¸‹æ–‡æ•°æ®
        updateConnectionStatus('æ­£åœ¨åŠ è½½æ•°æ®...', 'loading');
        contextData = await fetchContextData();

        // åˆå§‹åŒ–èŠå¤©
        isBackendConnected = true;
        updateConnectionStatus('å·²è¿æ¥', 'success');
        await initializeChat();

      } catch (error) {
        console.error('Initialization failed:', error);
        updateConnectionStatus('è¿æ¥å¤±è´¥: ' + error.message, 'error');
        isBackendConnected = false;
      }
    });

    // ========== UIäº¤äº’å‡½æ•° ==========
    function toggleChat() {
      const chatWindow = document.getElementById('ai-chat-window');
      const chatToggle = document.getElementById('ai-chat-toggle');

      if (chatWindow.style.display === 'none') {
        chatWindow.style.display = 'flex';
        chatToggle.style.display = 'none';
      } else {
        chatWindow.style.display = 'none';
        chatToggle.style.display = 'block';
        chatWindow.classList.remove('maximized');
        document.getElementById('ai-maximize-btn').textContent = 'â›¶';
      }
    }

    function toggleMaximize() {
      const chatWindow = document.getElementById('ai-chat-window');
      const maxBtn = document.getElementById('ai-maximize-btn');

      if (chatWindow.classList.contains('maximized')) {
        chatWindow.classList.remove('maximized');
        maxBtn.textContent = 'â›¶';
      } else {
        chatWindow.classList.add('maximized');
        maxBtn.textContent = 'â§‰';
      }
    }

    function toggleDefaultQuestions() {
      const content = document.getElementById('default-questions-content');
      const arrow = document.getElementById('default-questions-arrow');
      content.classList.toggle('collapsed');
      arrow.classList.toggle('collapsed');
    }

    // ========== æ¶ˆæ¯å¤„ç†å‡½æ•° ==========
    function addMessage(content, type) {
      const messagesDiv = document.getElementById('ai-chat-messages');
      const messageDiv = document.createElement('div');
      messageDiv.className = 'ai-message';

      if (type === 'user') {
        messageDiv.classList.add('ai-user-message');
      } else if (type === 'bot') {
        messageDiv.classList.add('ai-bot-message');
      } else if (type === 'error') {
        messageDiv.classList.add('ai-error-message');
      }

      messageDiv.textContent = content;
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      return messageDiv;
    }

    function getFriendlyErrorMessage(error) {
      const msg = error.message || '';
      if (msg.includes('401') || msg.includes('Unauthorized')) {
        return 'è®¤è¯å¤±è´¥ï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
      } else if (msg.includes('429')) {
        return 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•';
      } else if (msg.includes('500') || msg.includes('502') || msg.includes('503')) {
        return 'æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•';
      } else if (msg.includes('network') || msg.includes('Failed to fetch')) {
        return 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•';
      } else if (msg.includes('timeout')) {
        return 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åå†è¯•';
      }
      return 'å‘ç”Ÿé”™è¯¯ï¼Œè¯·ç¨åå†è¯•';
    }

    function trimChatHistory() {
      const systemMsgCount = chatHistory.filter(m => m.role === 'system').length;
      const nonSystemMsgCount = chatHistory.length - systemMsgCount;

      if (nonSystemMsgCount > MAX_CHAT_HISTORY) {
        const systemMsgs = chatHistory.filter(m => m.role === 'system');
        const nonSystemMsgs = chatHistory.filter(m => m.role !== 'system');
        chatHistory = [...systemMsgs, ...nonSystemMsgs.slice(-MAX_CHAT_HISTORY)];
      }
    }

    /**
     * å‘é€æ¶ˆæ¯åˆ°åå°APIï¼ˆæµå¼è¾“å‡ºï¼‰
     */
    async function sendMessage() {
      // æ£€æŸ¥åå°è¿æ¥
      if (!isBackendConnected) {
        addMessage('åå°æœåŠ¡æœªè¿æ¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
        return;
      }

      const userInput = document.getElementById('ai-user-input');
      const message = userInput.value.trim();

      if (!message) return;

      if (message.length > MAX_MESSAGE_LENGTH) {
        addMessage(`æ¶ˆæ¯è¿‡é•¿ï¼Œè¯·é™åˆ¶åœ¨ ${MAX_MESSAGE_LENGTH} ä¸ªå­—ç¬¦ä»¥å†…`, 'error');
        return;
      }

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      addMessage(message, 'user');
      chatHistory.push({ role: 'user', content: message });

      const currentQuestion = message;
      userInput.value = '';

      // ç¦ç”¨è¾“å…¥
      const sendBtn = document.getElementById('ai-send-btn');
      sendBtn.disabled = true;
      userInput.disabled = true;

      // åˆ›å»ºAIå›å¤æ¶ˆæ¯å…ƒç´ 
      const messagesDiv = document.getElementById('ai-chat-messages');
      const botMessageDiv = document.createElement('div');
      botMessageDiv.className = 'ai-message ai-bot-message';
      botMessageDiv.textContent = '';
      messagesDiv.appendChild(botMessageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      let fullResponse = '';

      try {
        // è°ƒç”¨åå°API
        const response = await sendChatToBackend(chatHistory);

        // è¯»å–æµå¼å“åº”
        const reader = response.body.getReader();
        const decoder = new TextDecoder('utf-8');

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value, { stream: true });
          const lines = chunk.split('\n');

          for (const line of lines) {
            if (!line.trim()) continue;
            if (line.startsWith(':')) continue;

            if (line.startsWith('data: ')) {
              const data = line.slice(6);
              if (data === '[DONE]') break;

              try {
                const parsed = JSON.parse(data);
                const content = parsed.choices?.[0]?.delta?.content || parsed.content || '';
                if (content) {
                  fullResponse += content;
                  botMessageDiv.textContent = fullResponse;
                  messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
              } catch (e) {
                // å¿½ç•¥è§£æé”™è¯¯
              }
            }
          }
        }

        // æ·»åŠ åˆ°å†å²è®°å½•
        chatHistory.push({ role: 'assistant', content: fullResponse });
        trimChatHistory();

        // å±•ç¤ºåˆ°é¡µé¢
        displayResultByQuestion(currentQuestion, fullResponse);

      } catch (error) {
        if (!fullResponse) {
          botMessageDiv.remove();
        }

        const friendlyMsg = getFriendlyErrorMessage(error);
        addMessage(friendlyMsg, 'error');
        console.error('Backend API Error:', error);

      } finally {
        sendBtn.disabled = false;
        userInput.disabled = false;
        userInput.focus();
      }
    }

    function askDefaultQuestion(question) {
      if (!isBackendConnected) {
        addMessage('åå°æœåŠ¡æœªè¿æ¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
        return;
      }
      document.getElementById('ai-user-input').value = question;
      sendMessage();
    }

    // ========== äº‹ä»¶ç›‘å¬ ==========
    document.addEventListener('DOMContentLoaded', function () {
      const userInput = document.getElementById('ai-user-input');
      if (userInput) {
        userInput.addEventListener('keypress', function (e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      }
    });
  </script>
</body>

</html>
